<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZAU SIA IDS</title>
<style>
body { font-family: monospace; margin:0; background-color:#0a0a0a; color:#fff; padding-bottom:150px; }
header { display:flex; justify-content:space-between; align-items:center; background-color:#1f1f1f; padding:0.8rem; border-bottom:2px solid #444; }
header h1 { font-size:1.8rem; margin:0; }
.user-actions-center { flex:1; display:flex; justify-content:center; }
.user-actions-center select { font-size:1.2rem; padding:0.4rem 0.8rem; border-radius:8px; border:none; background-color:#333; color:#fff; cursor:pointer; transition:background-color 0.2s; }
.user-actions-center select:hover { background-color:#444; }
.user-info-right { display:flex; align-items:center; gap:0.5rem; font-weight:bold; }
.user-info-right span { color:#fff; }
#logoutBtn { padding:0.4rem 1rem; background-color:#ff0000; color:#fff; border-radius:5px; border:none; cursor:pointer; }
#logoutBtn:hover { background-color:#cc0000; }

.airport-list { width:100%; margin-top:1rem; }
.airport-line { display:flex; flex-direction:row; justify-content:flex-start; padding:0.3rem 0.5rem; font-size:1.4rem; align-items:center; gap:1rem; border-bottom:1px solid #333; }
.code { width:120px; font-weight:bold; color:#fff; font-size:1.8rem; }
.atis { width:50px; font-weight:bold; color:#ffdd00; cursor:pointer; text-align:center; font-size:1.8rem; }
.flow { width:160px; color:#00ffff; display:flex; flex-direction:column; gap:0.1rem; cursor:pointer; }
.flow span{display:block;}
.winds { width:120px; color:#00ff00; font-weight:bold; }
.altimeter { width:80px; color:#ff6600; font-weight:bold; }
.metar { flex:1; color:#ccc; overflow-x:auto; }

.footer { position:fixed; bottom:0; left:0; width:100%; background-color:#1f1f1f; border-top:2px solid #444; display:flex; justify-content:center; padding:0.75rem 0; gap:0.5rem; z-index:1000; }
.footer a { padding:0.5rem 1.5rem; background-color:#18B28E; color:#fff; text-decoration:none; border-radius:5px; font-weight:bold; font-size:1.2rem; transition:background-color 0.2s; }
.footer a:hover { background-color:#139770; }

#inputModal, #loginModal { display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; background-color: rgba(0,0,0,0.7); justify-content:center; align-items:center; }
#inputModalContent, #loginModalContent { background-color:#1f1f1f; padding:1.5rem; border-radius:10px; text-align:center; width:300px; border:2px solid #ffdd00; }
#modalInput, #loginModal input { font-size:1.2rem; text-align:center; width:80%; padding:0.25rem; margin-bottom:1rem; border-radius:5px; border:none; }
#inputModal button, #loginModal button { font-size:1rem; padding:0.4rem 1rem; margin:0 0.25rem; border-radius:5px; border:none; cursor:pointer; font-weight:bold; }
#submitBtn, #loginSubmit { background-color:#00ff00; color:#000; }
#cancelBtn { background-color:#ff0000; color:#fff; }
#loginSubmit:hover { background-color:#00cc00; }
#cancelBtn:hover { background-color:#cc0000; }

#tmu-box { position:fixed; bottom:70px; left:20px; right:20px; max-height:200px; overflow-y:auto; background-color:#1f1f1f; border:2px solid #4ade80; border-radius:8px; padding:10px; font-family:monospace; color:#fff; }
#tmu-box h3 { margin-top:0; margin-bottom:5px; color:#4ade80; }
</style>
</head>
<body>

<header>
  <h1 id="headerClock">ZAU SIA IDS</h1>
  <div class="user-actions-center">
    <select id="sectorSelect">
      <option>Chicago TRACON (C90)</option>
      <option>Great Lakes TRACON (AZO)</option>
      <option>South Bend TRACON (SBN)</option>
      <option>Des Moines TRACON (DSM)</option>
      <option>Peoria TRACON (PIA)</option>
      <option>Quad Cities TRACON (MLI)</option>
      <option>Springfield TRACON (SPI)</option>
      <option>Milwaukee TRACON (MKE)</option>
      <option>Madison TRACON (MSN)</option>
      <option>Cedar Rapids TRACON (CID)</option>
      <option>ZAU Center High</option>
      <option>ZAU Center Low</option>
      <option>ZAU Center</option>
    </select>
  </div>
  <div class="user-info-right">
    <span id="userPosition">--</span>
    <span id="userInitials">--</span>
    <button id="logoutBtn">Logout</button>
  </div>
</header>

<div class="airport-list" id="airportList"></div>

<div id="tmu-box">
  <h3>TMU Messages</h3>
  <div id="tmu-feed-sia"></div>
</div>

<div class="footer">
  <a href="index.html">SIA</a>
  <a href="wx.html">WX</a>
  <a href="sop.html">SOP</a>
  <a href="pireps.html">PIREPS</a>
  <a href="brief.html">BRIEF</a>
  <a href="tmu.html">TMU</a>
</div>

<div id="inputModal">
  <div id="inputModalContent">
    <p id="modalTitle">Enter value:</p>
    <input type="text" id="modalInput" maxlength="10">
    <br>
    <button id="submitBtn">Submit</button>
    <button id="cancelBtn">Cancel</button>
  </div>
</div>

<div id="loginModal">
  <div id="loginModalContent">
    <h2>Sign In</h2>
    <input type="text" id="loginPosition" placeholder="Position Working" maxlength="10"><br>
    <input type="text" id="loginInitials" placeholder="Operator Initials" maxlength="5"><br>
    <button id="loginSubmit">Sign In</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const apiKey = "gSWFcq87dqsQjDxyR6huSD8j1zuvKkXYzLE9GKSBqYc";

// -------- CLOCK --------
function updateHeaderTime(){
  const now = new Date();
  const utc = now.getTime() + now.getTimezoneOffset()*60000;
  const cst = new Date(utc + 3600000*(-6));
  const h=('0'+cst.getHours()).slice(-2);
  const m=('0'+cst.getMinutes()).slice(-2);
  const s=('0'+cst.getSeconds()).slice(-2);
  document.getElementById('headerClock').textContent = `ZAU SIA IDS ${h}:${m}:${s}L`;
}
setInterval(updateHeaderTime,1000);
updateHeaderTime();

// -------- LOGIN --------
const loginModal=document.getElementById("loginModal");
const loginPosition=document.getElementById("loginPosition");
const loginInitials=document.getElementById("loginInitials");
const loginSubmit=document.getElementById("loginSubmit");
const userPosition=document.getElementById("userPosition");
const userInitials=document.getElementById("userInitials");
const logoutBtn=document.getElementById("logoutBtn");

function showLogin(){ loginModal.style.display="flex"; loginPosition.focus(); }
if(!localStorage.getItem("position")||!localStorage.getItem("initials")) showLogin();
else { userPosition.textContent=localStorage.getItem("position"); userInitials.textContent=localStorage.getItem("initials"); }

loginSubmit.addEventListener("click", ()=>{
  const pos=loginPosition.value.trim();
  const init=loginInitials.value.trim().toUpperCase();
  if(pos && init){
    localStorage.setItem("position",pos);
    localStorage.setItem("initials",init);
    userPosition.textContent=pos;
    userInitials.textContent=init;
    loginModal.style.display="none";
    loadSector(sectorSelect.value);
  } else alert("Please fill both fields!");
});
logoutBtn.addEventListener("click",()=>{ localStorage.clear(); showLogin(); });

// -------- SECTORS --------
const sectors={
  "Chicago TRACON (C90)": ["KORD","KMDW","KPWK","KDPA","KARR","KGYY","KUGN"],
  "Great Lakes TRACON (AZO)": ["KAZO","KBTL"],
  "South Bend TRACON (SBN)": ["KSBN"],
  "Des Moines TRACON (DSM)": ["KDSM"],
  "Peoria TRACON (PIA)": ["KPIA"],
  "Quad Cities TRACON (MLI)": ["KMLI"],
  "Springfield TRACON (SPI)": ["KSPI"],
  "Milwaukee TRACON (MKE)": ["KMKE","KMWC"],
  "Madison TRACON (MSN)": ["KMSN"],
  "Cedar Rapids TRACON (CID)": ["KCID"],
  "ZAU Center High": [], "ZAU Center Low": [], "ZAU Center": []
};
const airportList=document.getElementById("airportList");
const sectorSelect=document.getElementById("sectorSelect");
sectorSelect.addEventListener("change",()=>loadSector(sectorSelect.value));

// -------- MODAL --------
let currentElem=null;
const submitBtn=document.getElementById("submitBtn");
const cancelBtn=document.getElementById("cancelBtn");

function createAirportLine(icao){
  return `<div class="airport-line" data-icao="${icao}">
    <span class="code">${icao.replace('K','')}</span>
    <span class="atis" id="atis-${icao}">-</span>
    <span class="flow" id="flow-${icao}"><span class="arr">ARR: -</span><span class="dep">DEP: -</span></span>
    <span class="winds" id="wind-${icao}">-</span>
    <span class="altimeter" id="alt-${icao}">-</span>
    <span class="metar" id="metar-${icao}">Loading...</span>
  </div>`;
}

function openModal(elem,title){
  currentElem=elem;
  document.getElementById("modalTitle").textContent=`Enter ${title}:`;
  document.getElementById("modalInput").value=(elem.textContent==='-'?'':elem.textContent.replace(/(ARR: |DEP: )/g,''));
  document.getElementById("inputModal").style.display="flex";
}

function attachAirportListeners(){
  document.querySelectorAll(".atis").forEach(el=>el.addEventListener("click",()=>openModal(el, `ATIS letter for ${el.parentElement.dataset.icao}`)));
  document.querySelectorAll(".arr").forEach(el=>el.addEventListener("click",()=>openModal(el, `ARR flow for ${el.parentElement.parentElement.dataset.icao}`)));
  document.querySelectorAll(".dep").forEach(el=>el.addEventListener("click",()=>openModal(el, `DEP flow for ${el.parentElement.parentElement.dataset.icao}`)));
}

// -------- FIREBASE --------
const firebaseConfig = {
  apiKey: "AIzaSyBQhVG2_qIDV1R-fYuKkNdWxGriVImW5xs",
  authDomain: "zauids.firebaseapp.com",
  databaseURL: "https://zauids-default-rtdb.firebaseio.com",
  projectId: "zauids",
  storageBucket: "zauids.firebasestorage.app",
  messagingSenderId: "903788512771",
  appId: "1:903788512771:web:562b3abc452bf378b4b036",
  measurementId: "G-RDV11VC8Z1"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();
const tmuRef=db.ref('tmuMessages');
window.airportsRef=db.ref('tmuMessages/airports');

// TMU feed
tmuRef.on('value', snapshot=>{
  const msgsObj=snapshot.val()||{};
  const feed=document.getElementById('tmu-feed-sia');
  feed.innerHTML='';
  Object.values(msgsObj).forEach(msg=>{
    const div=document.createElement('div');
    div.textContent=(typeof msg==='string'? msg : msg.text);
    feed.appendChild(div);
  });
  feed.scrollTop=feed.scrollHeight;
});

// Sync ATIS/Flow from Firebase
window.airportsRef.on('value', snapshot=>{
  const airports=snapshot.val()||{};
  Object.keys(airports).forEach(icao=>{
    const data=airports[icao];
    const flowElem=document.getElementById('flow-'+icao);
    const atisElem=document.getElementById('atis-'+icao);
    const arrElem=flowElem? flowElem.querySelector('.arr'):null;
    const depElem=flowElem? flowElem.querySelector('.dep'):null;
    if(atisElem && data.atis!==undefined) atisElem.textContent=data.atis;
    if(arrElem && data.arr!==undefined) arrElem.textContent='ARR: '+data.arr;
    if(depElem && data.dep!==undefined) depElem.textContent='DEP: '+data.dep;
  });
});

// -------- LOAD SECTOR --------
async function loadSector(sector){
  airportList.innerHTML='';
  const list=sectors[sector];
  for(let i=0;i<list.length;i++){
    airportList.innerHTML+=createAirportLine(list[i]);
  }
  attachAirportListeners();

  for(let i=0;i<list.length;i++){
    const icao=list[i];
    // METAR
    try{
      const res=await fetch(`https://avwx.rest/api/metar/${icao}?options=info,translate`, { headers:{ Authorization: apiKey } });
      const data=await res.json();
      const metarElem=document.getElementById('metar-'+icao);
      const windElem=document.getElementById('wind-'+icao);
      const altElem=document.getElementById('alt-'+icao);
      if(data && data.raw){
        metarElem.textContent=data.raw;
        altElem.textContent=data.altimeter?.value?data.altimeter.value.toFixed(2):"-";
        let windText="-";
        if(data.wind?.degrees!=null && data.wind?.speed!=null) windText=`${data.wind.degrees}° @ ${data.wind.speed}kt`;
        else { const match=data.raw.match(/(\d{3})(\d{2,3})KT/); if(match) windText=`${match[1]}° @ ${match[2]}kt`; }
        windElem.textContent=windText;
      } else { metarElem.textContent="No METAR"; windElem.textContent="-"; altElem.textContent="-"; }
    } catch(e){ console.error(e); }

    // Load ATIS/Flow from Firebase
    if(window.airportsRef){
      const snapshot=await window.airportsRef.child(icao).get();
      const data=snapshot.val()||{};
      const flowElem=document.getElementById('flow-'+icao);
      const atisElem=document.getElementById('atis-'+icao);
      const arrElem=flowElem?flowElem.querySelector('.arr'):null;
      const depElem=flowElem?flowElem.querySelector('.dep'):null;
      if(atisElem) atisElem.textContent=data.atis||'-';
      if(arrElem) arrElem.textContent='ARR: '+(data.arr||'-');
      if(depElem) depElem.textContent='DEP: '+(data.dep||'-');
    }
  }
}

// -------- MODAL BUTTONS --------
submitBtn.addEventListener("click", ()=>{
  if(!currentElem) return;
  const val=document.getElementById("modalInput").value.trim();
  const icao=currentElem.parentElement.dataset.icao;
  let field='';
  if(currentElem.classList.contains('atis')) field='atis';
  else if(currentElem.classList.contains('arr')) field='arr';
  else if(currentElem.classList.contains('dep')) field='dep';

  if(field==='atis') currentElem.textContent=val?val.toUpperCase():'-';
  else currentElem.textContent=field.toUpperCase()+': '+(val?val:'-');

  // Update Firebase
  if(window.airportsRef){
    const obj={}; obj[field]=val?val.toUpperCase():'-';
    window.airportsRef.child(icao).update(obj);
  }

  document.getElementById("inputModal").style.display="none";
});
cancelBtn.addEventListener("click", ()=>{ document.getElementById("inputModal").style.display="none"; });
window.addEventListener("click",(e)=>{ if(e.target===document.getElementById("inputModal")) document.getElementById("inputModal").style.display="none"; });
window.addEventListener("keydown",(e)=>{
  if(document.getElementById("inputModal").style.display==="flex"){
    if(e.key==="Enter") submitBtn.click();
    if(e.key==="Escape") cancelBtn.click();
  }
});

// Load initial sector if logged in
if(localStorage.getItem("position") && localStorage.getItem("initials")) loadSector(sectorSelect.value);
</script>
</body>
</html>
